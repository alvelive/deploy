name: "Custom Deploy In Kubernates"
description: "Deploy to Dev Cluster"
inputs:
  repo:
    description: "Repository name"
    required: true
  branch:
    description: "Branch name"
    required: true
  commit-hash:
    description: "Commit hash"
    required: true
  github-token:
    description: "GitHub PAT to commit fleet-repo"
    required: true
  git-username:
    description: "Git username"
    required: true
  git-email:
    description: "Git e-mail"
    required: true
  fleet-repo:
    description: "Fleet repo"
    required: true
  fleet-values-path:
    description: "Fleet values.yaml path"
    required: true
runs:
  using: "composite"
  steps:
    - name: Clone Repository And Update
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.fleet-repo }}
        ref: ${{ inputs.branch }}
        token: ${{ inputs.github-token }}

    - name: Update Fleet
      shell: bash
      run: |
        sed -i "/^${{ inputs.repo }}:/ { n; s/.*/  imageTag: \"${{ inputs.commit-hash }}\"/; }" ${{ inputs.fleet-values-path }}

        git config --global user.name "${{ inputs.git-username }}"
        git config --global user.email "${{ inputs.git-email }}"
        git add .

        if git diff --staged --quiet; then
            echo "No changes to commit."
        else
            git commit -m "Update ${{ inputs.repo }} version to ${{ inputs.commit-hash }}"
            git push origin ${{ inputs.branch }}
        fi
